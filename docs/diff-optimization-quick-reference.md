# Diff ç®—æ³•ä¼˜åŒ– - å¿«é€Ÿå‚è€ƒ

## æ ¸å¿ƒå‡½æ•°

### `getNodeFieldChanges(currentNode, snapshotNode)`

**ç”¨é€”**ï¼šè®¡ç®—èŠ‚ç‚¹çš„å­—æ®µçº§åˆ«å˜åŒ–

**è¿”å›å€¼**ï¼š
```typescript
{
  changedFields: string[];  // å˜æ›´å­—æ®µåˆ—è¡¨ï¼Œå¦‚ ["position", "data.label"]
  changes: Partial<Node>;   // å…·ä½“çš„å˜æ›´å†…å®¹
} | null  // æ— å˜åŒ–æ—¶è¿”å› null
```

**ç¤ºä¾‹**ï¼š
```typescript
const info = getNodeFieldChanges(currentNode, snapshotNode);
if (info) {
  console.log(`å˜æ›´å­—æ®µ: ${info.changedFields.join(", ")}`);
  // è¾“å‡º: å˜æ›´å­—æ®µ: position, data.label, data.config
}
```

---

### `getEdgeFieldChanges(currentEdge, snapshotEdge)`

**ç”¨é€”**ï¼šè®¡ç®—è¾¹çš„å­—æ®µçº§åˆ«å˜åŒ–

**è¿”å›å€¼**ï¼š
```typescript
{
  changedFields: string[];  // å˜æ›´å­—æ®µåˆ—è¡¨ï¼Œå¦‚ ["label", "animated"]
  changes: Partial<UpdateWorkflowEdgeRequest>;  // åªåŒ…å«å˜æ›´å­—æ®µçš„æ›´æ–°å¯¹è±¡
} | null  // æ— å˜åŒ–æ—¶è¿”å› null
```

**ç¤ºä¾‹**ï¼š
```typescript
const info = getEdgeFieldChanges(currentEdge, snapshotEdge);
if (info) {
  console.log(`å˜æ›´å­—æ®µ: ${info.changedFields.join(", ")}`);
  // åªæäº¤å˜æ›´çš„å­—æ®µ
  await updateWorkflowEdge(edgeId, info.changes);
}
```

---

## ä¿å­˜ç»Ÿè®¡

### ç»Ÿè®¡å¯¹è±¡ç»“æ„

```typescript
const stats = {
  nodesCreated: 0,      // åˆ›å»ºçš„èŠ‚ç‚¹æ•°
  nodesUpdated: 0,      // æ›´æ–°çš„èŠ‚ç‚¹æ•°
  nodesDeleted: 0,      // åˆ é™¤çš„èŠ‚ç‚¹æ•°
  edgesCreated: 0,      // åˆ›å»ºçš„è¾¹æ•°
  edgesUpdated: 0,      // æ›´æ–°çš„è¾¹æ•°
  edgesDeleted: 0,      // åˆ é™¤çš„è¾¹æ•°
  totalFieldsChanged: 0 // æ€»å…±å˜æ›´çš„å­—æ®µæ•°
};
```

### ç»Ÿè®¡ä¿¡æ¯æ ¼å¼

```
èŠ‚ç‚¹: +2 ~3 -1 | è¾¹: +4 ~2 -0 | å…±æ›´æ–° 15 ä¸ªå­—æ®µ
```

**è§£è¯»**ï¼š
- `+2`ï¼šåˆ›å»ºäº† 2 ä¸ªèŠ‚ç‚¹
- `~3`ï¼šæ›´æ–°äº† 3 ä¸ªèŠ‚ç‚¹
- `-1`ï¼šåˆ é™¤äº† 1 ä¸ªèŠ‚ç‚¹
- `+4`ï¼šåˆ›å»ºäº† 4 æ¡è¾¹
- `~2`ï¼šæ›´æ–°äº† 2 æ¡è¾¹
- `-0`ï¼šåˆ é™¤äº† 0 æ¡è¾¹
- `15`ï¼šæ€»å…±æ›´æ–°äº† 15 ä¸ªå­—æ®µ

---

## æ—¥å¿—è¾“å‡ºç¤ºä¾‹

### èŠ‚ç‚¹å˜æ›´æ—¥å¿—

```
[å·¥ä½œæµä¿å­˜] èŠ‚ç‚¹ node-123 æ˜¯æ–°å¢èŠ‚ç‚¹
[å·¥ä½œæµä¿å­˜] èŠ‚ç‚¹ node-456 æœ‰å˜åŒ– (hash: abc123 -> def456)
[å·¥ä½œæµä¿å­˜] èŠ‚ç‚¹ node-456 çš„å˜æ›´å­—æ®µ: position, data.label
[å·¥ä½œæµä¿å­˜] èŠ‚ç‚¹ node-789 å·²è¢«åˆ é™¤
```

### è¾¹å˜æ›´æ—¥å¿—

```
[å·¥ä½œæµä¿å­˜] è¾¹ edge-123 æ˜¯æ–°å¢è¾¹
[å·¥ä½œæµä¿å­˜] è¾¹ edge-456 æœ‰å˜åŒ– (hash: ghi789 -> jkl012)
[å·¥ä½œæµä¿å­˜] è¾¹ edge-456 çš„å˜æ›´å­—æ®µ: label, animated, style
[å·¥ä½œæµä¿å­˜] è¾¹ edge-789 å·²è¢«åˆ é™¤
```

### ç»Ÿè®¡æ—¥å¿—

```
[å·¥ä½œæµä¿å­˜] èŠ‚ç‚¹ diff ç»“æœ: æ–°å¢ 2, ä¿®æ”¹ 3, åˆ é™¤ 1
[å·¥ä½œæµä¿å­˜] è¾¹ diff ç»“æœ: æ–°å¢ 4, ä¿®æ”¹ 2, åˆ é™¤ 0
[å·¥ä½œæµä¿å­˜] ğŸ“Š ä¿å­˜ç»Ÿè®¡: èŠ‚ç‚¹: +2 ~3 -1 | è¾¹: +4 ~2 -0 | å…±æ›´æ–° 15 ä¸ªå­—æ®µ
```

---

## æ£€æµ‹çš„å­—æ®µæ¸…å•

### èŠ‚ç‚¹å­—æ®µ

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `position` | Object | èŠ‚ç‚¹ä½ç½® (x, y) |
| `type` | String | èŠ‚ç‚¹ç±»å‹ |
| `data.label` | String | èŠ‚ç‚¹åç§° |
| `data.description` | String | èŠ‚ç‚¹æè¿° |
| `data.config` | Object | èŠ‚ç‚¹é…ç½® |
| `data.prompt` | String | æç¤ºè¯ |
| `data.processorLanguage` | String | å¤„ç†å™¨è¯­è¨€ |
| `data.processorCode` | String | å¤„ç†å™¨ä»£ç  |
| `data.apiConfig` | Object | API é…ç½® |
| `data.parallelConfig` | Object | å¹¶è¡Œé…ç½® |
| `data.branchNodes` | Object | åˆ†æ”¯èŠ‚ç‚¹é…ç½® |
| `data.async` | Boolean | å¼‚æ­¥æ ‡å¿— |
| `data.timeout` | Number | è¶…æ—¶æ—¶é—´ |
| `data.retryCount` | Number | é‡è¯•æ¬¡æ•° |
| `data.color` | String | èŠ‚ç‚¹é¢œè‰² |

### è¾¹å­—æ®µ

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `edgeKey` | String | è¾¹çš„å”¯ä¸€æ ‡è¯† |
| `sourceHandle` | String | æºèŠ‚ç‚¹å¥æŸ„ |
| `targetHandle` | String | ç›®æ ‡èŠ‚ç‚¹å¥æŸ„ |
| `type` | String | è¾¹ç±»å‹ (default/branch/parallel) |
| `label` | String | è¾¹æ ‡ç­¾ |
| `branchName` | String | åˆ†æ”¯åç§° |
| `animated` | Boolean | åŠ¨ç”»æ•ˆæœ |
| `style` | Object | æ ·å¼é…ç½® |
| `data` | Object | è‡ªå®šä¹‰æ•°æ® |

---

## ä¼˜åŒ–æ•ˆæœé€ŸæŸ¥

### æ•°æ®ä¼ è¾“ä¼˜åŒ–

| åœºæ™¯ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | å‡å°‘ |
|------|--------|--------|------|
| ä¿®æ”¹è¾¹æ ‡ç­¾ | 250 å­—èŠ‚ | 25 å­—èŠ‚ | 90% |
| ä¿®æ”¹èŠ‚ç‚¹ä½ç½® | 400 å­—èŠ‚ | 400 å­—èŠ‚* | 0%** |
| ä¿®æ”¹è¾¹æ ·å¼ | 250 å­—èŠ‚ | 80 å­—èŠ‚ | 68% |

\* èŠ‚ç‚¹æ›´æ–° API è¦æ±‚å¿…å¡«å­—æ®µ  
\** ä½†æä¾›äº†è¯¦ç»†çš„å˜æ›´æ—¥å¿—

### æ•°æ®åº“æ“ä½œä¼˜åŒ–

| åœºæ™¯ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | å‡å°‘ |
|------|--------|--------|------|
| 100 æ¡è¾¹ï¼Œ10 æ¡å˜åŒ– | 100 æ¬¡æ›´æ–° | 10 æ¬¡æ›´æ–° | 90% |
| 50 ä¸ªèŠ‚ç‚¹ï¼Œ5 ä¸ªå˜åŒ– | 50 æ¬¡æ›´æ–° | 5 æ¬¡æ›´æ–° | 90% |
| æ— å˜åŒ–çš„è¾¹ | æ‰§è¡Œæ›´æ–° | è·³è¿‡æ›´æ–° | 100% |

### æ€§èƒ½æå‡

| æŒ‡æ ‡ | æå‡å¹…åº¦ |
|------|----------|
| ç½‘ç»œä¼ è¾“ | 60-90% â†“ |
| æ•°æ®åº“è´Ÿè½½ | 50-80% â†“ |
| ä¿å­˜é€Ÿåº¦ | 30-50% â†‘ |
| æ—¥å¿—æ¸…æ™°åº¦ | 100% â†‘ |

---

## å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆèŠ‚ç‚¹æ›´æ–°è¿˜æ˜¯ä¼ è¾“æ‰€æœ‰å­—æ®µï¼Ÿ

**A**: å› ä¸ºåç«¯çš„ `UpdateWorkflowNodeRequest` è¦æ±‚å¿…å¡«å­—æ®µã€‚ä½†æˆ‘ä»¬çš„ä¼˜åŒ–æä¾›äº†ï¼š
- è¯¦ç»†çš„å˜æ›´å­—æ®µæ—¥å¿—
- ç²¾ç¡®çš„ç»Ÿè®¡ä¿¡æ¯
- ä¸ºæœªæ¥çš„å¢é‡æ›´æ–° API åšå‡†å¤‡

### Q2: è¾¹çš„æ›´æ–°å¦‚ä½•åšåˆ°åªä¼ è¾“å˜æ›´å­—æ®µï¼Ÿ

**A**: åç«¯çš„ `UpdateWorkflowEdgeRequest` æ‰€æœ‰å­—æ®µéƒ½æ˜¯å¯é€‰çš„ï¼Œæˆ‘ä»¬é€šè¿‡ `getEdgeFieldChanges` å‡½æ•°è®¡ç®—å‡ºå®é™…å˜æ›´çš„å­—æ®µï¼Œåªä¼ è¾“è¿™äº›å­—æ®µã€‚

### Q3: å¦‚ä½•åˆ¤æ–­ä¸€ä¸ªå­—æ®µæ˜¯å¦å˜åŒ–ï¼Ÿ

**A**: 
- ç®€å•ç±»å‹ï¼ˆstring, number, booleanï¼‰ï¼šä½¿ç”¨ `!==` æ¯”è¾ƒ
- å¤æ‚å¯¹è±¡ï¼ˆobject, arrayï¼‰ï¼šä½¿ç”¨ `JSON.stringify()` åºåˆ—åŒ–åæ¯”è¾ƒ

### Q4: ç»Ÿè®¡ä¿¡æ¯åœ¨å“ªé‡Œæ˜¾ç¤ºï¼Ÿ

**A**: 
- å¼€å‘ç¯å¢ƒï¼šæ§åˆ¶å°æ—¥å¿—ï¼ˆè¯¦ç»†ï¼‰
- ç”Ÿäº§ç¯å¢ƒï¼šä¿å­˜æˆåŠŸæ¶ˆæ¯ï¼ˆç®€æ´ï¼‰

### Q5: å¦‚ä½•è°ƒè¯•ä¿å­˜è¿‡ç¨‹ï¼Ÿ

**A**: 
1. æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°
2. æ‰§è¡Œä¿å­˜æ“ä½œ
3. æŸ¥çœ‹ `[å·¥ä½œæµä¿å­˜]` å¼€å¤´çš„æ—¥å¿—
4. æ£€æŸ¥å˜æ›´å­—æ®µå’Œç»Ÿè®¡ä¿¡æ¯

---

## æœ€ä½³å®è·µ

### 1. å¼€å‘æ—¶å¯ç”¨è¯¦ç»†æ—¥å¿—

```typescript
const DEBUG_ENABLED = !!import.meta.env.DEV;
```

å¼€å‘ç¯å¢ƒä¼šè‡ªåŠ¨æ˜¾ç¤ºè¯¦ç»†æ—¥å¿—ï¼Œä¾¿äºè°ƒè¯•ã€‚

### 2. å…³æ³¨ç»Ÿè®¡ä¿¡æ¯

ä¿å­˜åæŸ¥çœ‹ç»Ÿè®¡ä¿¡æ¯ï¼Œç¡®è®¤æ“ä½œç¬¦åˆé¢„æœŸï¼š
```
ä¿å­˜æˆåŠŸ (èŠ‚ç‚¹: +2 ~3 -1 | è¾¹: +4 ~2 -0 | å…±æ›´æ–° 15 ä¸ªå­—æ®µ)
```

### 3. åˆ©ç”¨å˜æ›´æ—¥å¿—æ’æŸ¥é—®é¢˜

å½“ä¿å­˜ç»“æœä¸ç¬¦åˆé¢„æœŸæ—¶ï¼ŒæŸ¥çœ‹è¯¦ç»†çš„å˜æ›´æ—¥å¿—ï¼š
```
èŠ‚ç‚¹ node-123 çš„å˜æ›´å­—æ®µ: position, data.label
```

### 4. ç›‘æ§æ€§èƒ½æŒ‡æ ‡

å®šæœŸæ£€æŸ¥ï¼š
- ä¿å­˜æ—¶é—´
- æ•°æ®ä¼ è¾“é‡
- æ•°æ®åº“æ“ä½œæ¬¡æ•°

---

## ä»£ç ç¤ºä¾‹

### åŸºæœ¬ä½¿ç”¨

```typescript
import { useWorkflowApplication } from './composables/useWorkflowApplication';

const { saveWorkflow } = useWorkflowApplication();

// ä¿®æ”¹èŠ‚ç‚¹
workflow.updateNode(nodeId, {
  position: { x: 100, y: 200 }
});

// ä¿å­˜ï¼ˆè‡ªåŠ¨è¿›è¡Œç²¾ç»†åŒ– diffï¼‰
await saveWorkflow();
// è¾“å‡º: ä¿å­˜æˆåŠŸ (èŠ‚ç‚¹: +0 ~1 -0 | è¾¹: +0 ~0 -0 | å…±æ›´æ–° 1 ä¸ªå­—æ®µ)
```

### æ‰¹é‡æ“ä½œ

```typescript
// æ‰¹é‡ä¿®æ”¹
nodes.forEach(node => {
  workflow.updateNode(node.id, {
    data: { color: '#4CAF50' }
  });
});

// ä¸€æ¬¡æ€§ä¿å­˜
await saveWorkflow();
// è¾“å‡º: ä¿å­˜æˆåŠŸ (èŠ‚ç‚¹: +0 ~10 -0 | è¾¹: +0 ~0 -0 | å…±æ›´æ–° 10 ä¸ªå­—æ®µ)
```

---

## æ€»ç»“

âœ… **ç²¾ç»†åŒ– diff**ï¼šå­—æ®µçº§åˆ«çš„å˜æ›´æ£€æµ‹  
âœ… **ä¼˜åŒ–ä¼ è¾“**ï¼šåªæäº¤å˜æ›´çš„å­—æ®µï¼ˆè¾¹ï¼‰  
âœ… **è¯¦ç»†æ—¥å¿—**ï¼šæ¸…æ™°çš„å˜æ›´è¿½è¸ª  
âœ… **ç»Ÿè®¡ä¿¡æ¯**ï¼šå®Œæ•´çš„æ“ä½œåé¦ˆ  
âœ… **æ€§èƒ½æå‡**ï¼š60-90% çš„ä¼˜åŒ–æ•ˆæœ  

è¿™äº›ä¼˜åŒ–è®©å·¥ä½œæµä¿å­˜æ›´å¿«ã€æ›´æ¸…æ™°ã€æ›´å¯æ§ï¼

